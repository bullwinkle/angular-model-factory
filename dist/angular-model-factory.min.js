/**
 * modelFactory makes working with RESTful APIs in AngularJS easy
 * @version v1.0.4 - 2018-04-07
 * @link http://swimlane.github.io/angular-model-factory/
 * @author Austin McDaniel <amcdaniel2@gmail.com>, Juri Strumpflohner <juri.strumpflohner@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */

"use strict";!function(e,t){"function"==typeof define&&define.amd?define(["angular","uri-templates","deep-diff"],t):"undefined"!=typeof module&&module.exports?module.exports=t(require("angular"),require("uri-templates"),require("deep-diff")):e.ModelFactory=t(e.angular,e.UriTemplate,e.DeepDiff)}(this,function($,h,v){var e=$.module("modelFactory",[]),m=$.isUndefined,y=$.forEach,g=$.extend,b=$.copy,O=["$$array","$save","$destroy","$pending","$rollback","$diff","$update","$commit","$copy"],q=["actions","instance","list","defaults","pk","stripTrailingSlashes","map"],E=function(r){return y(arguments,function(e){e!==r&&y(e,function(e,n){-1===O.indexOf(n)&&(r[n]?$.isArray(r[n])?r[n].concat(e.filter(function(e){var t=-1!==r[n].indexOf(e);return t&&E(t,e),t})):$.isObject(r[n])?E(r[n],e):r[n]=e:$.isFunction(r[n])||(r[n]=e))})}),r},T=function(n,r){for(var e in y(r=r||{},function(e,t){n.hasOwnProperty(t)||"$"===t.charAt(0)||delete r[t]}),n)n.hasOwnProperty(e)&&"$"!==e.charAt(0)&&($.isObject(n[e])&&!$.isArray(n[e])?r[e]=T(n[e],r[e]):r[e]=n[e]);return r};return e.provider("$modelFactory",function(){var r=this;r.defaultOptions={prefix:"",pk:"id",stripTrailingSlashes:!0,defaults:{},map:{},actions:{base:{wrap:!0,beforeRequest:void 0,afterRequest:void 0,cache:!1},get:{method:"GET"},query:{method:"GET",isArray:!0},post:{method:"POST",invalidateCache:!0},update:{method:"PUT",invalidateCache:!0},delete:{method:"DELETE",invalidateCache:!0}},instance:{},list:{}},r.$get=["$rootScope","$http","$q","$log","$cacheFactory",function(f,l,p,e,n){return function(u,c){var t={},e=u.split("/"),i=e[e.length-1];function o(n){(n=n||[]).forEach(function(e,t){null!=e&&(n[t]=a(e,n))});var r=n.push;return n.push=function(){for(var e=Array.prototype.slice.call(arguments),t=0;t<e.length;t++)e[t]=a(e[t],n);r.apply(n,e)},c.list&&g(n,c.list),n}c=E({},b(r.defaultOptions),c);var a=function(e,t){var n=e.constructor===d?e:new d(e);return n.$$array=t,n},s=function(e){var t=e.toString();return t=(t=t.substr("function ".length)).substr(0,t.indexOf("("))};function d(n){var r=this,a=[];n=n||{},y(c.defaults,function(e,t){void 0===n[t]&&(n[t]=b("function"==typeof e?e(n):e))}),y(c.map,function(e,t){s(e)===s(d)||s(e)===s(o)?n[t]=new e(n[t]):"function"==typeof e?n[t]=e(n[t],n):(n[t]=n[e],delete n[e])}),y(c.actions,function(e,t){"$"===t[0]&&(r[t]=function(){return d.$buildRequest(t,e,r)})}),g(r,n),g(r,b(c.instance)),r.$save=function(){var n=r[c.pk]?"update":"post",e=d[n](this);return r.$pending=!0,e.then(function(e){r.$pending=!1,e&&r.$update(e);var t="post"===n?"created":"updated";f.$broadcast(i+"-"+t,r),a.push($.toJson(r))},function(){r.$pending=!1}),e},r.$destroy=function(){var e=d.delete(this);return r.$pending=!0,e.then(function(){r.$pending=!1;var e=r.$$array;e&&e.splice(e.indexOf(r),1),f.$broadcast(i+"-destroyed",r)},function(){r.$pending=!1}),e},r.$diff=function(e){var t=a[e||a.length-1],n=$.toJson(r);return v.diff(JSON.parse(t),JSON.parse(n),function(e,t){return"$"===t[0]})},r.$commit=function(){return a.push($.toJson(r)),r},r.$rollback=function(e){var t=a[e||a.length-1];return r.$update(JSON.parse(t)),r},r.$update=function(e){return T(e,r),r},r.$copy=function(){var e=$.toJson(this);return new d($.fromJson(e))},r.$commit()}return d.$cache=n(u),y(c.actions,function(t,n){"base"!==n&&"$"!==n[0]&&(d[n]=function(){var e=Array.prototype.slice.call(arguments);return d.$buildRequest.apply(this,[n,t].concat(e))})}),d.$buildRequest=function(e,t,n,r){var a=b(c.actions.base);g(a,b(t)),!0===a.cache&&(a.cache=d.$cache),a.method=a.method||"GET";var i=c.prefix?c.prefix+"/":"";if(a.override)i=a.url;else if(i+=u,a.url&&(i+=/^(\/|{\/)/.test(a.url)?a.url:"/"+a.url),i=d.$url(i,n,a.method),"get"!==e&&"post"!==e&&"update"!==e&&"delete"!==e||(i+="{/"+c.pk+"}"),"GET"===a.method&&($.isString(n)||$.isNumber(n))){var o={};o[c.pk]=n,n=o,r&&(a.params=E({},a.params,r))}else"GET"===a.method&&$.isObject(n)&&(a.params=E({},a.params,n));return a.url=d.$url(i,n,a.method),"delete"!==e&&"DELETE"!==a.method&&(a.data=n),d.$call(a)},d.$call=function(n){var e=n.method+":"+n.url+":"+$.toJson(n.params);if(t[e])return t[e];var r=p.defer();return t[e]=r.promise,n.data=b(n.data),n.beforeRequest&&n.beforeRequest(n),n.data=d.$strip(n.data),l(n).then(function(e){if(n.afterRequest){var t=n.afterRequest(e.data);m(t)||(e.data=t)}n.invalidateCache&&d.$cache.removeAll(),e?n.wrap?n.isArray?r.resolve(new d.List(e.data)):r.resolve(new d(e.data)):r.resolve(e.data):r.resolve()},r.reject).finally(function(){t[e]=void 0}),r.promise},d.$url=function(e,n,r){var t=new h(e||u).fill(function(e){var t=n[e];return t?("GET"===r&&delete n[e],t):null});return c.stripTrailingSlashes&&(t=t.replace(/\/+$/,"")||"/"),t},d.$strip=function(n){return n&&"object"==typeof n&&y(n,function(e,t){-1<O.indexOf(t)&&delete n[t]}),n},y(c,function(e,t){-1===q.indexOf(t)&&(d[t]=e)}),d.List=o,d}}]}),e});